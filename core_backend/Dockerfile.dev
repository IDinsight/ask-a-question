FROM python:3.10-slim-bullseye

LABEL maintainer="IDinsight"

# Define arguments
ARG NAME=aaq_backend
ARG PORT=8000
ARG HOME_DIR=/usr/src/${NAME}
ARG WHISPER_MODEL_DIR=/whisper_models
ARG PANDOC_VERSION=3.2

# Install packages
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc libpq-dev python3-dev ffmpeg \
    libcairo2 libpango-1.0-0 libpangocairo-1.0-0 libpangoft2-1.0-0 \
    libgdk-pixbuf-2.0-0 libglib2.0-0 libharfbuzz0b libfribidi0 \
    libjpeg62-turbo libpng16-16 \
    fonts-dejavu fonts-liberation fonts-noto fonts-noto-cjk \
    curl xz-utils ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Install pandoc
RUN curl -L https://github.com/jgm/pandoc/releases/download/${PANDOC_VERSION}/pandoc-${PANDOC_VERSION}-linux-amd64.tar.gz \
    | tar xz -C /usr/local --strip-components=1 \
    && pandoc --version
# Set up directories
RUN mkdir -p ${HOME_DIR} ${WHISPER_MODEL_DIR} /tmp/prometheus

# Set environment variables
ENV PYTHONPATH="${PYTHONPATH}:${HOME_DIR}"
ENV PORT=${PORT}
ENV WHISPER_MODEL_DIR=${WHISPER_MODEL_DIR}

# Set working directory
WORKDIR ${HOME_DIR}

# Install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt --extra-index-url https://download.pytorch.org/whl/cpu

# Copy application code
COPY . .

# Download required models
RUN python -c "from transformers import AutoModel; AutoModel.from_pretrained('cross-encoder/ms-marco-MiniLM-L-6-v2')" && \
    python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('sentence-transformers/all-MiniLM-L6-v2')" && \
    python -c "from faster_whisper import WhisperModel; model = WhisperModel('tiny', download_root='${WHISPER_MODEL_DIR}')"

EXPOSE ${PORT}

CMD ["python", "main.py"]
